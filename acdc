#!/bin/bash

PYTHON_VERSION=3.6.9
DATA_DIR=@_DATA_DIR_@
PYENV_ROOT="$HOME/.pyenv"
PATH="$PYENV_ROOT/versions/$PYTHON_VERSION/bin:$PATH:$HOME/.local/bin"
cd "@_INSTALL_DIR_@"

if ! which pyenv > /dev/null 2> /dev/null
then
	PATH="$PATH:$PYENV_ROOT/bin"
fi

function update_pipenv()
{
	REQUIRED="$(md5sum Pipfile.lock | sed 's/\s.*//')"
	INSTALLED="$(cat "$DATA_DIR/.installed" 2> /dev/null)"

	if [ "$INSTALLED" != $REQUIRED ]
	then
		if ! which pipenv > /dev/null 2> /dev/null
		then
			pip3 install --user pipenv
		fi

		if ! which pyenv > /dev/null 2> /dev/null
		then
			echo -n 'Pyenv could not be found. Install it [Y/n]? '
			read ANSWER
			if [[ "$ANSWER" =~ ^([Yy][eEsS]*)?$ ]]
			then
				curl 'https://pyenv.run' | bash
			fi
		fi

		pyenv install --skip-existing $PYTHON_VERSION
		pipenv sync &&
		mkdir -p "$DATA_DIR" &&
		echo $REQUIRED > "$DATA_DIR/.installed"
	fi
}

if [ $# -eq 1 ] && [ "$1" = 'clean' ]
then
	pipenv --rm
	rm -rf "$DATA_DIR/"
else
	update_pipenv
	pipenv run ./toolkit.py "$@"
fi
